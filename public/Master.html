<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <title>Master</title>
  <link rel="stylesheet" href="/css/styles.css"> <!-- CSS einbinden -->
</head>

<body>
  <h1>Master</h1>
  <button id="showWindow" onclick="showShow()">show</button>
  <h2>Aufgaben auswählen</h2>
  <ul id="taskSelectionList">
    <!-- Dynamisch gefüllte Aufgabenliste -->
  </ul>
  <button id="startQuizButton" onclick="startQuiz()">Quiz starten</button>
  <button id="nextTaskButton" onclick="startNextTask()">Nächste Aufgabe starten</button>
  <h3>Fortschritt</h3>
  <ul id="progressList"></ul>
  <h4>Aktuelle Benutzer:</h4>
  <ul id="userList"></ul> <!-- Liste für Benutzer -->

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io(); // Verbindung zum Server
    const userListElement = document.getElementById("userList");

    // Event, um die Benutzerliste zu aktualisieren
    socket.on("updateUserList", (userNames) => {
      userListElement.innerHTML = ""; // Aktuelle Liste löschen
      userNames.forEach(name => {
        const listItem = document.createElement("li");
        listItem.textContent = name;
        userListElement.appendChild(listItem); // Benutzer zur Liste hinzufügen
      });
    });

    // Bei Verbindung Benutzerliste anfordern
    socket.emit("requestUserList");

    socket.emit("requestTaskPool"); // Anfrage an den Server senden

    const selectedTasks = [];

    //für dynamische Aufgabenansicht
    socket.on("sendTaskPool", (tasks) => {
      const taskList = document.getElementById("taskSelectionList");
      tasks.forEach(task => {
        const listItem = document.createElement("li");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = task.id;
        checkbox.onchange = (e) => {
          if (e.target.checked) {
            selectedTasks.push(task);
          } else {
            const index = selectedTasks.findIndex(t => t.id === task.id);
            if (index > -1) selectedTasks.splice(index, 1);
          }
        };
        listItem.appendChild(checkbox);
        listItem.appendChild(document.createTextNode(task.description));
        taskList.appendChild(listItem);
      });
    });

    function startQuiz() {
      if (selectedTasks.length > 0) {
        //document.getElementById("submitButton").style.display = "none";
        socket.emit("startQuiz", selectedTasks);
      } else {
        alert("Bitte wählen Sie mindestens eine Aufgabe aus.");
      }
    }

    // Fortschritt der Benutzer
    socket.on("progressUpdate", (progress) => {
      const progressList = document.getElementById("progressList");
      progressList.innerHTML = ""; // Vorherigen Fortschritt löschen
      progress.forEach(({ user, completed }) => {
        const listItem = document.createElement("li");
        listItem.textContent = `${user.name}: ${completed ? "Fertig" : "Nicht fertig"}`;
        progressList.appendChild(listItem);
      });
    });

    //für nächste Aufgabe zuerst Button anzeigen
    socket.on("nextTaskButton", () => {
      const nextTaskButton = document.getElementById("nextTaskButton");
      nextTaskButton.style.display = "block"; // Button sichtbar machen
    });


    //beim Betätigen des Buttons nächste Aufgabe anzeigen, Button unsichtbar
    function startNextTask() {
      // Button ausblenden
      document.getElementById("nextTaskButton").style.display = "none";
      // Server mitteilen, dass die nächste Aufgabe gestartet wird
      socket.emit("startNextTask");
    }

    //show öffnen
    function showShow() {
      window.open('show.html', '_blank');
    }


  </script>
</body>

</html>