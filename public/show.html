<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Spielansicht</title>
    <link rel="stylesheet" href="/css/showStyle.css"> <!-- CSS-Datei einbinden -->
</head>

<body>
    <!-- Oberer Bereich -->
    <div class="questionText">
        <h1 id="questionText">Aufgabenanzeige</h1>
        <pre id="codeDisplay" style="display: none;"></pre>
    </div>

    <!-- Unterer Bereich -->
    <div class="bottom-section">
        <!-- Linker Bereich -->
        <div class="left-box">
            <div id="chart-container" class="chart-container"></div>
        </div>

        <!-- Rechte Spalte -->
        <div class="right-box">
            <div class="timer">30 Sekunden</div>
            <div class="progress-bar">
                <div class="progress-bar-inner" id="progressBar"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        socket.on("newTask", (task) => {
            const questionText = document.getElementById("questionText");
            const codeDisplay = document.getElementById("codeDisplay");
            const questionTextContainer = document.querySelector(".questionText");
            questionTextContainer.style.backgroundColor = "#fff";


            // Setze die Fragebeschreibung
            questionText.textContent = task.description;

            // Prüfen, ob es Code gibt
            if (task.type === "output" || task.type === "coding") {
                // Code anzeigen und zentrierte Klasse entfernen
                codeDisplay.style.display = "block";
                codeDisplay.textContent = task.template;
                questionTextContainer.classList.add("code");
            } else {
                // Code ausblenden und zentrierte Klasse hinzufügen
                codeDisplay.style.display = "none";
                questionTextContainer.classList.remove("code");
            }
        });



        // Korrekte Lösung anzeigen
        socket.on("taskCompleted", (correctAnswer) => {
            const questionTextContainer = document.querySelector(".questionText");
            const codeDisplay = document.getElementById("codeDisplay");
            questionTextContainer.classList.remove("code");
            questionTextContainer.style.backgroundColor = "#d4edda";
            codeDisplay.style.display = "none";
            document.getElementById("questionText").textContent = `Korrekte Antwort: ${correctAnswer}`;
        });

        //------------------Balkendiagramm------------------------------------------

        socket.on("loadDiagram", (players) => {
            // Sortiere Spieler nach Punkten, max. 15 anzeigen
            const topPlayers = players.sort((a, b) => b.points - a.points).slice(0, 15);

            // Höchste Punktzahl bestimmen
            const maxPoints = topPlayers[0]?.points || 1;

            const chartContainer = document.getElementById("chart-container");
            chartContainer.innerHTML = ""; // Vorherigen Inhalt löschen

            topPlayers.forEach((player, index) => {
                // Erstelle Balken
                const bar = document.createElement("div");
                bar.classList.add("bar");
                if (index === 0) bar.classList.add("gold");
                else if (index === 1) bar.classList.add("silver");
                else if (index === 2) bar.classList.add("bronze");

                // Höhe des Balkens prozentual zur maximalen Punktzahl
                bar.style.height = `${(player.points / maxPoints) * 100}%`;

                // Name und Punkte hinzufügen
                const label = document.createElement("span");
                label.innerHTML = `${player.name}<br>${player.points} Pkt`;
                bar.appendChild(label);

                // Balken zum Chart hinzufügen
                chartContainer.appendChild(bar);
            });
        });




        // ----------------------Fortschrittsbalken-------------------------------------
        let duration = 30;
        let currentProgress = 100;

        function updateProgressBar() {
            const progressBarInner = document.getElementById("progressBar");
            const timer = document.querySelector(".timer");

            const interval = setInterval(() => {
                if (currentProgress <= 0) {
                    clearInterval(interval);
                    timer.textContent = "Zeit abgelaufen!";
                } else {
                    currentProgress -= 100 / duration;
                    progressBarInner.style.height = `${currentProgress}%`;
                    timer.textContent = `${Math.ceil((duration * currentProgress) / 100)} Sekunden`;
                }
            }, 1000);
        }

        window.onload = updateProgressBar;
    </script>
</body>

</html>