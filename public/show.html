<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Spielansicht</title>
    <link rel="stylesheet" href="/css/showStyle.css"> <!-- CSS-Datei einbinden -->
</head>

<body>
    <!-- Oberer Bereich -->
    <div class="questionText">
        <h1 id="questionText">Aufgabenanzeige</h1>
        <pre id="codeDisplay" style="display: none;"></pre>
    </div>

    <!-- Unterer Bereich -->
    <div class="bottom-section">
        <!-- Linker Bereich -->
        <div class="left-box">
            <div id="chart-container" class="chart-container"></div>
        </div>

        <!-- Rechte Spalte -->
        <div class="right-box" id="right-Box">
            <div class="timer">Verbleibende Zeit</div>
            <div class="progress-bar">
                <div class="progress-bar-inner" id="progressBar"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        socket.on("newTask", (task) => {
            const questionText = document.getElementById("questionText");
            const codeDisplay = document.getElementById("codeDisplay");
            const questionTextContainer = document.querySelector(".questionText");
            questionTextContainer.style.backgroundColor = "#fff";

            // Setze die Fragebeschreibung
            questionText.textContent = task.description;

            //Timer auf anfang:
            timerReset();

            // Prüfen, ob es Code gibt
            if (task.type === "output" || task.type === "coding") {
                // Code anzeigen und zentrierte Klasse entfernen
                codeDisplay.style.display = "block";
                codeDisplay.textContent = task.template;
                questionTextContainer.classList.add("code");
            } else {
                // Code ausblenden und zentrierte Klasse hinzufügen
                codeDisplay.style.display = "none";
                questionTextContainer.classList.remove("code");
            }
        });

        //Alles auf Anfang zurücksetzen
        socket.on("reset", () => {
            const questionText = document.getElementById("questionText");
            const codeDisplay = document.getElementById("codeDisplay");
            const questionTextContainer = document.querySelector(".questionText");
            questionTextContainer.style.backgroundColor = "#fff";
            questionText.textContent = "Aufgabenstellung";
            codeDisplay.style.display = "none";
            questionTextContainer.classList.remove("code");
            timerReset();
        });


        // Korrekte Lösung anzeigen
        socket.on("taskCompleted", (correctAnswer) => {
            const questionTextContainer = document.querySelector(".questionText");
            const codeDisplay = document.getElementById("codeDisplay");
            questionTextContainer.classList.remove("code");
            questionTextContainer.style.backgroundColor = "#d4edda";
            codeDisplay.style.display = "none";
            document.getElementById("questionText").textContent = `Korrekte Antwort: ${correctAnswer}`;
            timerReset();
        });

        //------------------Balkendiagramm------------------------------------------

        socket.on("loadDiagram", (players) => {
            // Sortiere Spieler nach Punkten, max. 15 anzeigen
            const topPlayers = players.sort((a, b) => b.points - a.points).slice(0, 15);

            // Höchste Punktzahl bestimmen
            const maxPoints = topPlayers[0]?.points || 1;

            const chartContainer = document.getElementById("chart-container");
            chartContainer.innerHTML = ""; // Vorherigen Inhalt löschen

            topPlayers.forEach((player, index) => {
                // Erstelle Balken
                const bar = document.createElement("div");
                bar.classList.add("bar");
                if (index === 0) bar.classList.add("gold");
                else if (index === 1) bar.classList.add("silver");
                else if (index === 2) bar.classList.add("bronze");

                // Höhe des Balkens prozentual zur maximalen Punktzahl
                bar.style.height = `${(player.points / maxPoints) * 100}%`;

                // Name und Punkte hinzufügen
                const label = document.createElement("span");
                label.innerHTML = `${player.name}<br>${player.points} Pkt`;
                bar.appendChild(label);

                // Balken zum Chart hinzufügen
                chartContainer.appendChild(bar);
            });
        });




        // ----------------------Fortschrittsbalken-------------------------------------
        socket.on("timeLeft", (time) => {
            updateProgressBar(time);
        });

        let progressInterval = null; // Variable, um das laufende Intervall zu speichern
        let remainingTime = 0; // Globale Variable für die verbleibende Zeit

        function updateProgressBar(duration) {
            remainingTime = duration;
            const progressBarInner = document.getElementById("progressBar");
            const timer = document.querySelector(".timer");
            const rigthBox = document.getElementById("right-Box");
            const totalHeight = 100; // Fortschrittsbalken startet bei 100%
            const interval = 1000; // Intervallzeit: 1 Sekunde
            const decrement = totalHeight / remainingTime; // Berechnung der Höhe, die pro Intervall reduziert wird
            if (progressInterval) { // Sicherstellen, dass ein laufender Timer abgebrochen wird
                clearInterval(progressInterval);
            }
            progressInterval = setInterval(() => {
                if (remainingTime <= 0) {
                    clearInterval(progressInterval); // Timer stoppen, wenn Zeit abgelaufen
                    progressBarInner.style.height = "0%"; // Fortschrittsbalken auf 0% setzen
                    timer.textContent = "Zeit abgelaufen!";
                    socket.emit("timeLost");
                } else {
                    remainingTime -= 1; // Reduziere die verbleibende Zeit um 1 Sekunde
                    progressBarInner.style.height = `${remainingTime * decrement}%`; // Fortschrittsbalken anpassen
                    timer.textContent = `${remainingTime} Sekunden`; // Zeitanzeige aktualisieren
                    rigthBox.style.backgroundColor = "rgba(255, 0, 0, 0.3)"; // Leicht rot
                }
            }, interval);
        }

        //Timer und Fortschrittsbalken vollständig zurücksetzen
        function timerReset() {
            const progressBarInner = document.getElementById("progressBar");
            const timer = document.querySelector(".timer");
            const rightBox = document.getElementById("right-Box");
            if (progressInterval) { //laufenden Timer stoppen
                clearInterval(progressInterval);
                progressInterval = null; // Timer-Variable zurücksetzen
            }
            progressBarInner.style.height = "100%"; // Fortschrittsbalken auf 100% setzen
            timer.textContent = "Verbleibende Zeit"; // Timer-Anzeige zurücksetzen
            rightBox.style.backgroundColor = "#d4edda"; // Hintergrund auf Standard-Grün zurücksetzen
        }

        socket.on("addTimeForShow", (additionalTime) => {
            remainingTime += additionalTime; // Verbleibende Zeit um die zusätzliche Zeit erhöhen
        });

        window.onload = () => {
            timerReset(); // Timer direkt nach dem Laden zurücksetzen
        };


    </script>
</body>

</html>