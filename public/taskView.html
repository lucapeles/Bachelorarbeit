<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <title>Quiz</title>
  <link rel="stylesheet" href="/css/styles.css"> <!-- CSS einbinden -->
</head>

<body>
  <h1>Programmierung-Quiz</h1>
  <div id="quizContainer">
    <div id="answerOptions"></div>
    <button id="submitButton" onclick="submitAnswer()">Antwort abschicken</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // URL-Parameter auslesen
    const urlParams = new URLSearchParams(window.location.search);
    const userID = urlParams.get('userID'); // ID des Benutzers aus der URL holen
    let startTime; // Startzeitpunkt des Timers
    let elapsedTime; // Verstrichene Zeit in Sekunden

    // Neue Frage anzeigen
    socket.on("newTask", (task) => {
      document.body.style.backgroundColor = "white";
      document.getElementById("quizContainer").style.display = "block"; // Container wieder sichtbar machen
      document.getElementById("submitButton").style.display = "block"; //submitButton wieder sichtbar machen

      const optionsContainer = document.getElementById("answerOptions");
      optionsContainer.innerHTML = ""; // Vorherige Antworten löschen

      startTime = Date.now(); // Zeitstempel beim Start der Aufgabe
      elapsedTime = 0; // Timer zurücksetzen

      if (task.type === "multipleChoice") {
        task.options.forEach((option) => {
          const button = document.createElement("button");
          button.textContent = option;
          button.className = "optionButton";
          button.onclick = () => selectAnswer(button, option);
          optionsContainer.appendChild(button);
        });
      } else if (task.type === "coding") {
        const editorContainer = document.createElement("textarea");
        editorContainer.id = "codeEditor";
        editorContainer.classList.add("largeTextArea"); // CSS-Klasse zuweisen
        editorContainer.value = task.template || "";   // Template-Inhalt einsetzen
        optionsContainer.appendChild(editorContainer);
      } else if (task.type === "text" || task.type === "output") {
        const textArea = document.createElement("textarea");
        textArea.id = "textAnswer";
        textArea.classList.add("largeTextArea"); // CSS-Klasse zuweisen
        optionsContainer.appendChild(textArea);
      }
    });

    let selectedAnswer = "nurAlsSchranke";
    let previousSelectedButton = null;

    function selectAnswer(button, answer) {
      selectedAnswer = answer;

      // Entferne die Markierung von der vorherigen Auswahl
      if (previousSelectedButton) {
        previousSelectedButton.classList.remove("selected");
      }

      // Markiere die aktuelle Auswahl
      button.classList.add("selected");
      previousSelectedButton = button; // Speichere die aktuelle Auswahl
    }

    function submitAnswer() {
      document.getElementById("submitButton").style.display = "none"; //submitButton ausblenden
      document.getElementById("quizContainer").style.display = "none"; // Antwortmöglichkeiten ausblenden
      // Falls es sich um eine Text- oder Output-Aufgabe handelt:
      const textAnswer = document.getElementById("textAnswer");
      if (textAnswer) {
        selectedAnswer = textAnswer.value.trim(); // Eingabe aus Textfeld holen und speichern
      }
      if (selectedAnswer != "nurAlsSchranke") {
        elapsedTime = Math.floor((Date.now() - startTime) / 1000);
        socket.emit("submitTask", [userID, selectedAnswer, elapsedTime]);
      } else {
        alert("Bitte gib eine Lösung ein.")
      }
    }

    socket.on("showTrueOrFalse", (userIDs) => {
      if (userIDs.includes(userID)) {
        document.body.style.backgroundColor = "lightgreen";
      } else {
        document.body.style.backgroundColor = "lightcoral";
      }
    });

    socket.on("quizCompleted", (results) => {
      alert("Das Quiz ist beendet!");
      // Ergebnisse anzeigen
    });

    socket.on("reset", () => {
      document.body.style.backgroundColor = "white";
      document.getElementById("quizContainer").style.display = "none";
      document.getElementById("submitButton").style.display = "none";
    });

    // Benutzer beim Verlassen der Seite abmelden
    window.addEventListener("beforeunload", () => {
      socket.emit("disconnectUser", userID);
    });

  </script>
</body>

</html>